<!doctype html>
<html lang="zh-cn">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Java并发-Synchronized和Reentrantlock | LeeReindeer&#39;s blog</title>
    <meta property="og:title" content="Java并发-Synchronized和Reentrantlock - LeeReindeer&#39;s blog">
    <meta property="og:type" content="article">
    
    <meta property="article:published_time" content='2019-01-07T10:31:21&#43;08:00'>
    
    
    <meta property="article:modified_time" content='2019-01-07T10:31:21&#43;08:00'>
    
    <meta name="Keywords" content="">
    <meta name="description"
        content="
Java中对线程的同步和互斥有两种方式：使用synchronized关键字和使用ReentranLock 。也有其他的实现比如信号量，在操作系统里也有学到。
Java并发-目录
">
    
    <meta name="author" content="LeeR">
    <meta property="og:url" content="https://leer.moe/2019/01/07/java-concurrent-synchronized-reentrantlock/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
           <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    

    
    
</head>

<body>
  <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://leer.moe/">
                        LeeReindeer&#39;s blog
                    </a>
                
                <p class="description">Dive in</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://leer.moe/">首页</a>
                    
                    <a  href="https://leer.moe/archives/" title="归档">归档</a>
                    
                    <a  href="https://leer.moe/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

  <div id="body">
    
    <div class="container">
      <div class="col-group">

        <div class="col-8" id="main">
          
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 260px;
        margin-top: 1%;
        right: 8.5%;
         
        margin-right: 1%;
        padding: 5px 10px;
        font-size: 12px;
         
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
         
         
         
        word-wrap: break-word;
        line-height: 1.5;
         
         
         
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 18px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
        color: #ba3925;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">Java并发-Synchronized和Reentrantlock</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ol>
    <li><a href="#临界区管理的问题">临界区管理的问题</a></li>
    <li><a href="#synchronized">synchronized</a>
      <ol>
        <li><a href="#synchronized的使用">synchronized的使用</a></li>
        <li><a href="#synchronized的解决方案">synchronized的解决方案</a></li>
        <li><a href="#synchronized-原理">synchronized 原理</a></li>
      </ol>
    </li>
    <li><a href="#reentrantlock">ReentrantLock</a>
      <ol>
        <li><a href="#reentrantlock-的使用">ReentrantLock 的使用</a></li>
        <li><a href="#reentrantlock的解决方案">ReentrantLock的解决方案</a></li>
      </ol>
    </li>
    <li><a href="#可重入">可重入</a></li>
    <li><a href="#synchronized-和-reentrantlock-的区别">synchronized 和 ReentrantLock 的区别</a></li>
    <li><a href="#参考">参考</a></li>
  </ol>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            
            
            
            

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Java并发-Synchronized和Reentrantlock</h1>
        </header>
        <date class="post-meta meta-date">
            2019年1月7日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://leer.moe/categories/%E8%87%AA%E4%B9%A0%E5%AE%A4'>自习室</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span>|</span>
            <span class="meta-category">2275 words</span>
        </div>
        
        
        
        <div class="post-content">
            <blockquote>
<p>Java中对线程的同步和互斥有两种方式：使用<code>synchronized</code>关键字和使用<code>ReentranLock</code> 。也有其他的实现比如信号量，在操作系统里也有学到。</p>
<p><a href="/2019/01/06/java-concurrent-toc/">Java并发-目录</a></p>
</blockquote>
<h2 id="临界区管理的问题">临界区管理的问题</h2>
<p>临界区是多个并发的进程中访问共享变量的代码段。如果多个线程同步访问一个共享变量，而不加以限制，会产生和时间相关的错误，导致结果不一致。</p>
<p>比如一个售票系统，它的简单代码如下：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">WrongTicket</span> <span style="color:#000;font-weight:bold">implements</span> Runnable <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">int</span> num <span style="color:#000;font-weight:bold">=</span> 100<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>num <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sleep</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
          <span style="color:#000;font-weight:bold">}</span>
          System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentThread</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;: sale &#34;</span> <span style="color:#000;font-weight:bold">+</span> num<span style="color:#000;font-weight:bold">--);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      WrongTicket ticket <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> WrongTicket<span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>输出结果可能会是这样的：</p>
<pre><code>Thread-3: sale 10
Thread-0: sale 9
Thread-1: sale 8
Thread-2: sale 7
Thread-0: sale 6
Thread-3: sale 6
Thread-1: sale 5
Thread-2: sale 4
Thread-1: sale 3
Thread-3: sale 1
Thread-0: sale 3
Thread-2: sale 2
</code></pre><p>Thread-1和Thread-0卖出来同一张票，这显然是不合理的。</p>
<p>也可能出现这种情况：</p>
<pre><code>Thread-0: sale 10
Thread-2: sale 9
Thread-3: sale 8
Thread-1: sale 7
Thread-0: sale 6
Thread-2: sale 5
Thread-3: sale 4
Thread-1: sale 3
Thread-0: sale 2
Thread-2: sale 1
Thread-3: sale 0
Thread-1: sale -1
Thread-0: sale -2
</code></pre><p>在票卖完之后，还继续输出，导致结果是负数。</p>
<p>导致这些结果的原因是，没有对<code>num</code>这个共享变量的访问加以限制，如果在同一时刻只有一个进程可以访问共享变量，并且在结束之前把共享变量的值同步到主内存。另一个进程开始后从主内存读取共享变量。这样就可以保证数据的一致性，或者说是内存的可见性。解决这个问题的方法有两个：<code>synchronized</code>和<code>ReentrantLock</code>。</p>
<h2 id="synchronized">synchronized</h2>
<p><code>synchronized</code>是Java中的关键字，在访问临界区之前当前线程需要获得对象锁，也就是对象的monitor。</p>
<p><code>synchronized</code>的使用方式主要为代码块同步和方法同步。</p>
<h3 id="synchronized的使用">synchronized的使用</h3>
<h4 id="代码块同步">代码块同步</h4>
<ul>
<li>对象同步</li>
</ul>
<p>只有对同一个对象实例执行这段代码时，才能达到互斥访问的效果，因为锁住的是这一个对象。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">synchronized</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>类同步</li>
</ul>
<p>锁住的是类，即使存在多个对象实例，也可以互斥的访问这段代码。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">synchronized</span><span style="color:#000;font-weight:bold">(</span>SynchronizedTest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="方法同步">方法同步</h4>
<ul>
<li>对象同步</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><ul>
<li>类同步</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><h3 id="synchronized的解决方案">synchronized的解决方案</h3>
<p>只要对临界区这段代码加上代码块同步即可：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Ticket</span> <span style="color:#000;font-weight:bold">implements</span> Runnable <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">int</span> num <span style="color:#000;font-weight:bold">=</span> 100<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
          Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sleep</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// lock this Object
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>num <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentThread</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;: sale &#34;</span> <span style="color:#000;font-weight:bold">+</span> num<span style="color:#000;font-weight:bold">--);</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      Ticket ticket <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Ticket<span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="synchronized-原理">synchronized 原理</h3>
<p>代码块同步和方法同步，两者虽然实现细节不同，但本质上都是对一个对象的监视器（monitor）的获取。<strong>任意一个对象都拥有自己的监视器</strong>，当同步代码块或同步方法时，执行方法的线程必须先获得该对象的监视器才能进入同步块或同步方法，没有获取到监视器的线程将会被阻塞，并进入同步队列，状态变为<code>BLOCKED</code>。当成功获取监视器的线程释放了锁后，会唤醒阻塞在同步队列的线程，使其重新尝试对监视器的获取。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">public</span> moe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">leer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">javareview</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">concurrent</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Test</span><span style="color:#000;font-weight:bold">();</span>
    descriptor<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">()</span>V
    flags<span style="color:#000;font-weight:bold">:</span> ACC_PUBLIC
    Code<span style="color:#000;font-weight:bold">:</span>
      stack<span style="color:#000;font-weight:bold">=</span>1<span style="color:#000;font-weight:bold">,</span> locals<span style="color:#000;font-weight:bold">=</span>1<span style="color:#000;font-weight:bold">,</span> args_size<span style="color:#000;font-weight:bold">=</span>1
         0<span style="color:#000;font-weight:bold">:</span> aload_0
         1<span style="color:#000;font-weight:bold">:</span> invokespecial <span style="color:#a61717;background-color:#e3d2d2">#</span>1                  <span style="color:#998;font-style:italic">// Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span><span style="color:#998;font-style:italic"></span>         4<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">return</span>
      LineNumberTable<span style="color:#000;font-weight:bold">:</span>
        line 7<span style="color:#000;font-weight:bold">:</span> 0

  <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method1</span><span style="color:#000;font-weight:bold">();</span>
    descriptor<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">()</span>V
    flags<span style="color:#000;font-weight:bold">:</span> ACC_PUBLIC
    Code<span style="color:#000;font-weight:bold">:</span>
      stack<span style="color:#000;font-weight:bold">=</span>2<span style="color:#000;font-weight:bold">,</span> locals<span style="color:#000;font-weight:bold">=</span>3<span style="color:#000;font-weight:bold">,</span> args_size<span style="color:#000;font-weight:bold">=</span>1
         0<span style="color:#000;font-weight:bold">:</span> aload_0
         1<span style="color:#000;font-weight:bold">:</span> dup
         2<span style="color:#000;font-weight:bold">:</span> astore_1
         3<span style="color:#000;font-weight:bold">:</span> monitorenter
         4<span style="color:#000;font-weight:bold">:</span> aload_1
         5<span style="color:#000;font-weight:bold">:</span> monitorexit
         6<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">goto</span>          14
         9<span style="color:#000;font-weight:bold">:</span> astore_2
        10<span style="color:#000;font-weight:bold">:</span> aload_1
        11<span style="color:#000;font-weight:bold">:</span> monitorexit
        12<span style="color:#000;font-weight:bold">:</span> aload_2
        13<span style="color:#000;font-weight:bold">:</span> athrow
        14<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">return</span>

  <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method2</span><span style="color:#000;font-weight:bold">();</span>
    descriptor<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">()</span>V
    flags<span style="color:#000;font-weight:bold">:</span> ACC_PUBLIC<span style="color:#000;font-weight:bold">,</span> ACC_SYNCHRONIZED
    Code<span style="color:#000;font-weight:bold">:</span>
      stack<span style="color:#000;font-weight:bold">=</span>0<span style="color:#000;font-weight:bold">,</span> locals<span style="color:#000;font-weight:bold">=</span>1<span style="color:#000;font-weight:bold">,</span> args_size<span style="color:#000;font-weight:bold">=</span>1
         0<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">return</span>
      LineNumberTable<span style="color:#000;font-weight:bold">:</span>
        line 16<span style="color:#000;font-weight:bold">:</span> 0
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>同步方法通过<code>ACC_SYNCHRONIZED</code>关键字隐式的对方法进行加锁。当线程要执行的方法被标注上<code>ACC_SYNCHRONIZED</code>时，需要先获得锁才能执行该方法。</p>
<p>同步代码块通过<code>monitorenter</code>和<code>monitorexit</code>执行来进行加锁。当线程执行到<code>monitorenter</code>的时候要先获得所锁，才能执行后面的方法。当线程执行到<code>monitorexit</code>的时候则要释放锁。</p>
<p>每个对象自身维护这一个被加锁次数的计数器，当计数器数字为0时表示可以被任意线程获得锁。当计数器不为0时，只有获得锁的线程才能再次获得锁。即可重入锁。</p>
<ul>
<li>
<p>synchronized 为什么反编译后 只有一个moniter enter，但是却有两个moiter exit？</p>
<p>个人想法（没有得到验证）：为了防止临界区中的代码段发生异常，从而没有执行<code>monitorexit</code>就退出了，会造成死锁。</p>
</li>
</ul>
<h2 id="reentrantlock">ReentrantLock</h2>
<blockquote>
<p>A reentrant mutual exclusion {@link Lock} with the same basic
behavior and semantics as the implicit monitor lock accessed using
{@code synchronized} methods and statements, but with extended
capabilities.</p>
</blockquote>
<p>上面的描述在<code>ReentrantLock</code>源码的注释中。一个可重入锁和<code>synchronized</code>关键字实现的基本功能类似，都可以获取对象的monitor，来实现互斥访问。<code>ReentrantLock</code>在此基础上扩展了一些功能。</p>
<h3 id="reentrantlock-的使用">ReentrantLock 的使用</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ReentrantLock lock <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ReentrantLock<span style="color:#000;font-weight:bold">();</span>

publick <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lock</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">//do something
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unlock</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="reentrantlock的解决方案">ReentrantLock的解决方案</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">LockTicket</span> <span style="color:#000;font-weight:bold">implements</span> Runnable <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">int</span> num <span style="color:#000;font-weight:bold">=</span> 100<span style="color:#000;font-weight:bold">;</span>
    ReentrantLock lock <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ReentrantLock<span style="color:#000;font-weight:bold">();</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
          Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sleep</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>num <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lock</span><span style="color:#000;font-weight:bold">();</span>
          System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentThread</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;: sale &#34;</span> <span style="color:#000;font-weight:bold">+</span> num<span style="color:#000;font-weight:bold">--);</span>
          lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unlock</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      LockTicket ticket <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> LockTicket<span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Thread<span style="color:#000;font-weight:bold">(</span>ticket<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="可重入">可重入</h2>
<p><code>synchronized</code>和<code>ReentrantLock</code>都是可重入的。那么什么是可重入呢？</p>
<p>就是如果已经获得这把锁，那么可以再次获取。</p>
<ul>
<li>synchronized</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>SynchronizedTest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;method1 get lock&#34;</span><span style="color:#000;font-weight:bold">);</span>
      method2<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">//可重入锁：已经获得锁的进程可以再次获得这把锁。
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>SynchronizedTest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;method2 get lock again&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>ReentrantLock</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lock</span><span style="color:#000;font-weight:bold">();</span>
      System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;method1 get lock&#34;</span><span style="color:#000;font-weight:bold">);</span>
      method2<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unlock</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">//可重入锁：已经获得锁的进程可以再次获得这把锁。
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">method2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lock</span><span style="color:#000;font-weight:bold">();</span>
      System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;method2 get lock&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      lock<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unlock</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="synchronized-和-reentrantlock-的区别">synchronized 和 ReentrantLock 的区别</h2>
<p>1）Lock是一个接口，而synchronized是Java中的关键字，synchronized是内置的语言实现；</p>
<p>2）synchronized在发生异常时，会自动释放线程占有的锁，因此不会导致死锁现象发生；而Lock在发生异常时，如果没有主动通过unLock()去释放锁，则很可能造成死锁现象，因此使用Lock时需要在finally块中释放锁；</p>
<p>3）Lock可以让等待锁的线程响应中断，而synchronized却不行，使用synchronized时，等待的线程会一直等待下去，不能够响应中断；</p>
<p>4）通过Lock可以知道有没有成功获取锁，而synchronized却无法办到。</p>
<p>5）Lock可以提高多个线程进行读操作的效率。</p>
<h2 id="参考">参考</h2>
<ul>
<li>
<p>JDK1.8 源码</p>
</li>
<li>
<p><a href="https://github.com/LRH1993/android_interview/blob/master/java/concurrence/synchronized-reentrantlock.md">Synchronized/ReentrantLock</a></p>
</li>
</ul>
        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2019/01/06/java-concurrent-toc/">Java并发-目录</a></li>
        
        <li><a href="/2018/12/20/java-fun-pass-by-value/">Java基础-Pass by value</a></li>
        
        <li><a href="/2018/12/17/data-structrue-treap/">数据结构-Treap</a></li>
        
        <li><a href="/2018/12/17/java-fun-arraylist-linkedlist/">Java基础-ArrayList和LinkedList</a></li>
        
        <li><a href="/2018/12/16/java-fun-hashmap/">Java基础-HashMap源码简析</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://leer.moe/tags/java'>Java</a></li>
                
                <li><a href='https://leer.moe/tags/java%E5%B9%B6%E5%8F%91'>Java并发</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "LeeReindeer/LeeReindeer.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

        </div>
        
        
        
        
      </div>
    </div>
  </div>
  <footer id="footer">
    <div class="container">
        &copy; 2021 <a href="https://leer.moe/">LeeReindeer&#39;s blog</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>
        <a href="https://github.com/LeeReindeer/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
    <div class="container" id="showDays"></div>
</footer>
<script type="text/javascript" src='/js/sitedate.js' async=""></script>





<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






</body>

</html>